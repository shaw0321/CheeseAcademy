<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<script src="js/jquery-2.1.3.min.js"></script>
<link rel="stylesheet" href="css/reset.css">

<link rel="stylesheet" href="css/sample.css">

<title>MIL(Majang I~~~ League)</title>
</head>
<body>

<header>
  <h1 class="title">MIL(Majang I~~~ League)</h1>
  <input type="button" class="btn" id="loginpagebtn" value="log out">
</header>

<main>
  <section class="charge_area">
  
    <p class="point_area title">ポイント残高: <span class="value" id="value"></span>P<span class="alert title" style ="display: none;">←課金してチャージしてね</span></p>
    <!-- <p class = "btn"><label class="open" for="pop-up">課金</label></p> -->
    <label class="open btn" for="pop-up">課金</label>
  </section>
  <section class="player">
    <div class="player1">
      <h1 class= "title">プレイヤー：<span id="player_name"></span>様</h1>
      <UL class="haipai">
        <li id=1><img src="./img/pai-images/ji6-66-90-l-emb.png"></li>
        <li id=2><img src="./img/pai-images/ji6-66-90-l-emb.png"></li>
        <li id=3><img src="./img/pai-images/ji6-66-90-l-emb.png"></li>
        <li id=4><img src="./img/pai-images/ji6-66-90-l-emb.png"></li>
        <li id=5><img src="./img/pai-images/ji6-66-90-l-emb.png"></li>
        <li id=6><img src="./img/pai-images/ji6-66-90-l-emb.png"></li>
        <li id=7><img src="./img/pai-images/ji6-66-90-l-emb.png"></li>
        <li id=8><img src="./img/pai-images/ji6-66-90-l-emb.png"></li>
        <li id=9><img src="./img/pai-images/ji6-66-90-l-emb.png" ></li>
        <li id=10><img src="./img/pai-images/ji6-66-90-l-emb.png"></li>
        <li id=11><img src="./img/pai-images/ji6-66-90-l-emb.png" ></li>
        <li id=12><img src="./img/pai-images/ji6-66-90-l-emb.png" ></li>
        <li id=13 class="rightend"><img src="./img/pai-images/ji6-66-90-l-emb.png" ></li>
        <li id=14  >
          <img src="./img/pai-images/ji6-66-90-l-emb.png" class="selected">
        </li>
    </UL>
    </div>
  </section>

 
  <section>
    <!-- ボタンとかを書く領域 -->
    <div>
      <ul class="btns">
        <li class="btn haipai_btn">配牌</li>
        <li class="btn sorting_btn">理牌</li>
        <li class="btn" id="test">テスト</li>

        <!-- <li class="btn tenho">天和判定</li> -->
      </ul>
    </div>
  </section>

  <!-- 課金画面に関する記述 -->
<input type="checkbox" id="pop-up">
<div class="overlay">
	<div class="window">
		<label class="close title" for="pop-up">×</label>
		<p class="text title">料金表</p>
    <div>
      <ul class="tariff"> 
        <li>
          <p class="tariff_left">100P</p>
          <p class ="tariff_right btn charge100" value="100">100<span>円</span></p>
        </li>
        <li>
          <p class="tariff_left">1000P</p>
          <p class ="tariff_right btn charge1000" value="1000">500<span>円</span></p>
        </li>
        <li>
          <p class="tariff_left">5000P</p>
          <p class ="tariff_right btn charge5000" value="5000">じゃんけん</p>
        </li>
      </ul>


    </div>
	</div>
</div>

<!--/ コンテンツ表示画面 -->




<!--チャット表示画面 サンプルエリア -->
<!-- 
  <section class="chatArea">
      <UL  class="chatRows">
          <li class="chatRow ${isMyself}" value="${key}">
              <div class="iconArea">
                  <span class="icon">写真</span>
              </div>
              <div class="contentArea">
                  <div class="nameArea">
                      ${msg.uname}
                  </div>
                  <div class="messageArea">
                      ${msg.text}
                  </div>
              </div>
              <div class="dateArea">
                  <dv class="year_month_day">
                      ${msg.year}/${msg.month}/${msg.day}
                  </dv>
                  <dv class= "hour_minute">
                      ${msg.hour}:${msg.minute}
                  </dv>
              </div>

              <div class="deleteArea">
                  <button id="delete" class= ${key}>削除</button>
              </div>
          </li>
          <li class="messageRow" id="myself">
               <div class="chatRow" id="others">

                  <div class="contentArea">
                      <div class="nameArea">
                          池辺
                      </div>
                      <div class="messageArea">
                          お早う
                      </div>
                  </div>
                  <div class="date">
                      2021/12/11
                  </div>
              </div>
          </li>
      </UL>
  </section> -->

<!-- 
</section> -->

  <!-- chat表示エリア -->


  <section class="chatArea truechatArea">
          <!-- 入力画面 -->

        <div class="inputArea">

            <label for="text" class="label">チャット</label>
            <!-- <input type="text" id="text" class="input"> -->
            <textarea  id="text" class="input"></textarea>

            <!-- <textarea  id="text" cols="30" rows="5"></textarea> -->
            <!-- <button id="send">送信</button> -->
        </div>



    <UL  class="chatRows" id="output">

    </UL>
  </section>


  
</main>
<footer class="title">MIL(Majang I~~~ League)</footer>

<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries
  
      import { getDatabase, ref, push, set, onChildAdded, remove, onChildRemoved, onValue }
          from "https://cdnjs.cloudflare.com/ajax/libs/firebase/9.6.0/firebase-database.min.js";
    
      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "",
        authDomain: "gsapp-cb6e9.firebaseapp.com",
        projectId: "gsapp-cb6e9",
        storageBucket: "gsapp-cb6e9.appspot.com",
        messagingSenderId: "208815022139",
        appId: "1:208815022139:web:9cc201aadcca3c8ceffc1e"
      };
    
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      // console.log(app);
  
      const db = getDatabase(app);
      // console.log(db);
  
      const dbRef = ref(db, "chat")




// 未ログイン状態でこのページに来た時、loginページに遷移させる
if(localStorage.getItem("login") == ""){
    alert("未ログインのため、Login画面に遷移します。");
    window.location.href = "./login.html";
}


// ポイント表示欄に関する処理
// 未ログイン状態出ないことを確認する。
if(localStorage.getItem("login") !== ""){
  // 初回ログインの場合、表示とポイント付与を行う
  if(localStorage.getItem(localStorage.getItem("login") + "_point") === null){
    alert("初回ログインボーナスで1,000P付与します")
    localStorage.setItem(localStorage.getItem("login") + "_point", 1000);
    display_point(0);

  // 初回ログインでない場合、LSに保存されているポイント数を表示する
  }else{
    display_point(0);
  }{

}}


//  プレイヤー名に関する処理
$("#player_name").html(localStorage.getItem("login").substr(3,));



// ログアウトボタンに関する処理
// ログアウトボタンを押すと、LSのloginの値を空にして、ログインページに遷移する
$("#loginpagebtn").on("click", function(){
  localStorage.setItem("login","");
  window.location.href = "./login.html" ;
})


 // 残高確認をして、残高が引く数より少ないときtrue,多いときfalseを返す関数
 function isShort(point_to_substract){
    let value = Number(localStorage.getItem(localStorage.getItem("login") + "_point"));
    if(point_to_substract > value){
      return true;
    }else{
      return false;
    }
  }


  // 残高確認を行う関数
  function checkAccount(amount){
    if(isShort(amount)){
      // 残高不足の時の処理を書く
      $(".alert").show();
    }else{
      // 残高が十分な時の処理を書く
      display_point(amount);
    };
  }

    // ポイント数を減算して、減算後の数字を表示する関数
    function display_point(point_to_substract){
    let value = Number(localStorage.getItem(localStorage.getItem("login") + "_point"));
    localStorage.setItem(localStorage.getItem("login") + "_point",value - point_to_substract);
    $("#value").html(Number(localStorage.getItem(localStorage.getItem("login") + "_point")));
  }




// 牌に関する処理
  const hai = [0,"man1","man2","man3","man4","man5","man6","man7","man8","man9","pin1","pin2","pin3","pin4","pin5","pin6","pin7","pin8","pin9","sou1","sou2","sou3","sou4","sou5","sou6","sou7","sou8","sou9","ji1","ji2","ji3","ji4","ji5","ji6","ji7"];
 
  // 配牌と自摸の消費ポイント
  const haipai_point = 100;
  const tsumo_point = 10;




  // 自摸の処理を記述する関数 n=自摸牌数
function TSUMO(haipai,yama, length, buttom,n){
  for(let i =0; i < n; ){
      let hai_num = Math.ceil(length*Math.random()+buttom) ;
      if(yama[hai_num] > 0){
        haipai.push(hai_num);
        yama[hai_num] = yama[hai_num] - 1;
        i++;
      };
     };

  // yamaをLSに保存する。
  SAVE_YAMA(yama);

  // haipai配列を返す；
  return haipai;
}


  // 配牌のインデックスを選択する関数
  function HAIPAI(haipai, yama, length, buttom){
    // 配牌を初期化
     haipai =[];

    // buttomから length分の範囲の牌をランダムでhaipaiに格納する
    TSUMO(haipai,yama,length,buttom,14);
    return haipai;
    };

    
  // 配牌インデックスを並び変える関数
  function compareFunc(a, b) {
  return a - b;
  };

  // 配牌を表示する関数 start=表示する牌の始点、end=表示する牌の終点
  function DISPLAY(player_number,haipai,start,end){
    for(let j =start; j <= end; j++){
      $(".player" + player_number).find("#" + j).children('img').attr("src", "./img/pai-images/" +hai[haipai[j-1]] + "-66-90-l-emb.png");
    };
    // for(let j =1; j <= 14;j++){
    //     // console.log();
    //   $(".player" + number).find("#" + j).children('img').fadeIn(j*100);
    // };

  }




// yamaを保存する処理を書く
// 保存先として、LS、firebase等を選べるようにする
function SAVE_YAMA(yama){
    if (window.localStorage) {
    let json = JSON.stringify(yama, undefined, 1);
    localStorage.setItem(localStorage.getItem("login") + "_yama", json);
  };
}


// yamaを取得する時の処理を書く
// 取得先として、LS、firebase等を選べるようにする
function LOAD_YAMA(){
  if (window.localStorage) {
    let json = localStorage.getItem(localStorage.getItem("login") + "_yama");
    let yama_str = JSON.parse(json);
    let yama_num = yama_str.map(function (e) {
    return Number(e);
    });
   
  return yama_num
  }
}

// haipaiを保存する処理を書く
// 保存先として、LS、firebase等を選べるようにする
function SAVE_HAIPAI(haipai){
    if (window.localStorage) {
    let json = JSON.stringify(haipai, undefined, 1);
    localStorage.setItem(localStorage.getItem("login") + "_haipai", json);
  };
}


// haipaiを取得する時の処理を書く
// 取得先として、LS、firebase等を選べるようにする
function LOAD_HAIPAI(){
  if (window.localStorage) {
    let json = localStorage.getItem(localStorage.getItem("login") + "_haipai");
    let haipai_str = JSON.parse(json);
    let haipai_num = haipai_str.map(function (e) {
    return Number(e);
    });
   
  return haipai_num
  }
}

// sutehaiを保存する処理を書く
// 保存先として、LS、firebase等を選べるようにする
function SAVE_KAWA(kawa){
    if (window.localStorage) {
    let json = JSON.stringify(kawa, undefined, 1);
    localStorage.setItem(localStorage.getItem("login") + "_KAWA", json);
  };
  console.log(kawa);
}


// kawaを取得する時の処理を書く
// 取得先として、LS、firebase等を選べるようにする
function LOAD_KAWA(){
  if (window.localStorage) {
    let json = localStorage.getItem(localStorage.getItem("login") + "_KAWA");
    let kawa_str = JSON.parse(json);

    let kawa_num = kawa_str.map(function (e) {
    return Number(e);
    });
   


  return kawa_num
  }
}



// 捨て牌に関する処理を書く

function SUTEHAI(sutehai){
  // LSに保存されているsutehaiをロードする
  let kawa = LOAD_KAWA();

  // 捨て牌をプッシュする
  kawa.push(sutehai);

  // 捨て牌を保存する
  SAVE_KAWA(kawa);

}



// 理牌の処理を書く
function SORT(haipai){
  //  理牌ボタンを押したときにhaipaiの1~13までをソートする、14番目は残す
  var newArray =  haipai.slice(0,13);
    var fourteenth = haipai.slice(13,14);
    newArray.sort(compareFunc)
    haipai = newArray.concat(fourteenth);
    return haipai;
}








  //配牌ボタンを押したときの処理を記述する
  $('.haipai_btn').on("click",function(){
    // 残ポイント数がhaipai_pointより少ない時の処理を書く
    //残高不足案内を出す  
    if(isShort(haipai_point)){
      $(".alert").show();
      
    // 残ポイント数が十分な時の処理を書く
    }else{

      // selectedクラスを初期化する。選択中の牌を未選択にし、14番めを選択中にする。
      $(".selected").removeClass("selected");
      $("#14").attr("class", "selected");

      // 配牌ボタンを押すたびに山を元に戻す
      let yama= [0,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4];

      // haipai配列の初期化
      let haipai =[];

      // 配牌ボタンを押すたびに捨て牌を元に戻す
      let kawa=[];

      // 捨て牌を保存する
      SAVE_KAWA(kawa);
      console.log(kawa);

      // 未ソートのhaipai配列を作成する
      haipai = HAIPAI(haipai, yama, 34, 0);  
      SAVE_HAIPAI(haipai);

      // haipai配列に対応した牌画像を画面に表示する
      DISPLAY(1,haipai,1,14);

      // 残ポイント数からhaipai_pointをマイナスする
      display_point(haipai_point);
    };
    
  });


// 理牌ボタンを押した時の処理を記述する
$('.sorting_btn').on("click",function(){
    
    let haipai = LOAD_HAIPAI();
    haipai = SORT(haipai);
    SAVE_HAIPAI(haipai);

    DISPLAY(1,haipai,1,14);
    
  });





// 牌をクリックした時の処理を記載する
$('img').on("click",function(){

  // 選択済みの牌をクリックした時の処理
  // 捨て牌、自摸の処理をかむ
  if($(this).hasClass("selected")) {

    // 残ポイント数がhaipai_pointより少ない時の処理を書く
    if(isShort(tsumo_point)){

       //残高不足案内を出す  
       $(".alert").show();
      
    // 残ポイント数が十分な時の処理を書く
    }else{

      // 選択した牌に対応するhaipaiのkeyを選択
      var number = Number($(this).parent().attr("id")) - 1;

      // 現在のhaipaiをロード
      let haipai = LOAD_HAIPAI();

      let sutehai = haipai[number];

      //haipaiからnumberに位置する値を削除
      haipai.splice(number ,1);

      // 捨て牌配列に追加する
      SUTEHAI(sutehai);


      //選択した牌のselectedクラスを削除
      $(this).removeClass("selected");

      // LSからyama配列を取得する
      let yama =LOAD_YAMA(); 

      // 14番目の牌を自摸する
      TSUMO(haipai,yama,34,0,1);

      // 理牌する
      haipai = SORT(haipai);

      // haipaiを保存する
      SAVE_HAIPAI(haipai);

      // 1~14番目の牌画像を更新
      DISPLAY(1,haipai,1,14);

      // 14番目の画像にselectedクラスを付与
      $(".player" + 1).find("#14").children('img').attr("class", "selected");

      // 残ポイント数からtsumo_pointをマイナスする
      display_point(tsumo_point);
    };

  // 未選択の牌をクリックした時の処理
  }else{

    // 選択中の牌を未選択にし、選択した牌を選択中にする。
    $(".selected").removeClass("selected");
    $(this).attr("class", "selected");
    
  }

  });








// 課金処理
$('.charge100').on("click",function(){
   let add_point = 100;
  
  // 残ポイントにadd_pointを加算する
  display_point(-add_point);
  
  // アラートをけす
  $(".alert").hide();
    });

$('.charge1000').on("click",function(){
   let add_point = 1000;
  
  // 残ポイントにadd_pointを加算する
  display_point(-add_point);

  // アラートをけす
  $(".alert").hide();    
    });

$('.charge5000').on("click",function(){

  alert("未実装です");
    });    







// チャットの記述

    // ユーザーネーム設定
    const username = localStorage.getItem("login").substr(3,)

    

    // textボックスでエンターキーを押したときの処理
    $("#text").on("keydown",function(e){
        if ( e.which == 13 ) {
        // ここに処理を記述
        const text = $("#text").val();


                let date = new Date();
                const year =  date.getFullYear();
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const hour = date.getHours();
                const minute = date.getMinutes();

                const msg = {
                    uname: username,
                    text: text,
                    year: year,
                    month: month,
                    day: day,
                    hour: hour,
                    minute: minute

                }
                // console.log(uname);
                // const newPostRef = dbRef.push();
                const newPostRef = push(dbRef);
                set(newPostRef, msg);
            // return false;
          


      }
      // $("#text").val("");
	})


    //chatRowを生成する関数
    function creatChatRow(data, a){
        const msg =data.val();
        // オブジェクトのkeyを取得
        const key = data.key;

        let isMyself =  a;


        let h =
            `<li class="chatRow ${isMyself}" value="${key}">
                <div class="contentArea">
                    <div class="nameArea">
                        ${msg.uname}
                    </div>
                    <div class="messageArea">
                        ${msg.text}
                    </div>
                </div>
                <div class="dateArea">
                    <dv class="year_month_day">
                        ${msg.year}/${msg.month}/${msg.day}
                    </dv>
                    <dv class= "hour_minute">
                        ${msg.hour}:${msg.minute}
                    </dv>
                </div>

                <div class="deleteArea">
                    <button id="delete" class= ${key}>削除</button>
                </div>
            </li>`;

            // console.log(isMyself);

        $("#output").append(h);
    } 


    // iconAreaを除去
    // <div class="iconArea">
    //                 <span class="icon">写真</span>
    //             </div>


    // データ受信機能の実装

    onChildAdded(dbRef, function(data){

        // unameが自分だった時の処理
        if(data.val().uname == username){

              // 一番下までスクロールされていれば追加後も一番下までスクロールする
          if (isScrollBottom()) {
            creatChatRow(data, "myself");
            scrollToBottom();
            console.log("スクロール");

          }
          // 一番下までスクロールされていなければスクロールしない
          else {
            creatChatRow(data, "myself");
            // console.log(isScrollBottom());

            // console.log("スクロールしない");
          }
 
        // unameが他人だった時の処理
        }else{

               // 一番下までスクロールされていれば追加後も一番下までスクロールする
            if (isScrollBottom()) {
              creatChatRow(data, "others");
              scrollToBottom();
            console.log("スクロール");

          }
              // 一番下までスクロールされていなければスクロールしない
          else {
            creatChatRow(data, "others");
            // console.log(isScrollBottom());
            // console.log("スクロールしない");


          }

        }
    })



// チャット更新時に最新までスクロール
    // 下までスクロールする
    function scrollToBottom () {
      $(".truechatArea").scrollTop = $(".truechatArea").scrollHeight;
    };

     // 一番下までスクロールしているかどうか
     function isScrollBottom () {
      // console.log($(".chatRows").scrollHeight);

      return $(".chatRows").scrollHeight === $(".chatRows").scrollTop + $(".chatRows").offsetHeight;
    };







    // 削除ボタンを押したときの処理
    // 押されたボタンが属するli要素を削除する
    $(document).on("click","#delete", function(){
        
        // 押されたボタンが属するli要素のvalueの値をkeyに格納
           const key = $(this).parents("li").attr("value");
    
        // firebaseRDBのkey以下の要素を削除する
           remove(ref(db, "chat/" + key));
    
        //押されたボタンが属するli要素を削除する
           $(this).parents('li').remove();
    
    
    })

  
</script>
</body>
</html>
