<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Sankey Diagram作成画面</title>

        <!-- bootstrapの記述 -->
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="">
        <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
        <meta name="generator" content="Hugo 0.88.1">
        <link rel="canonical" href="https://getbootstrap.com/docs/4.6/examples/navbars/">

        <!-- Bootstrap core CSS -->
        <link href="./assets/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
          .bd-placeholder-img {
            font-size: 1.125rem;
            text-anchor: middle;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
          }
    
          @media (min-width: 768px) {
            .bd-placeholder-img-lg {
              font-size: 3.5rem;
            }
          }
        </style>
        <!-- Custom styles for this template -->
        <link href="./css/navbar.css" rel="stylesheet">

        <!-- Jqueryのインストール -->
        <script src="js/jquery-2.1.3.min.js"></script>

        <!-- google chart-->
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        <!-- google chart終了-->


    </head>
    <body>

      <!-- ナビゲーション -->
      <nav class="navbar navbar-expand-sm navbar-dark bg-dark">
          <a class="navbar-brand" href="./index.html">Sankey Diagram</a>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExample03" aria-controls="navbarsExample03" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
        
          <div class="collapse navbar-collapse" id="navbarsExample03">
            <ul class="navbar-nav mr-auto" id="navAppend">
              <li class="nav-item active">
                <a class="nav-link" >username<span id="loginname"></span></a>
              </li>
              <!-- <li class="nav-item active">
                <a class="nav-link" id="logoutbtn" >ログアウト</a>
              </li> -->
              <!-- <li class="nav-item">
                <a class="nav-link" href="#">Link</a>
              </li>
              <li class="nav-item">
                <a class="nav-link disabled">Disabled</a>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="dropdown03" data-toggle="dropdown" aria-expanded="false">Dropdown</a>
                <div class="dropdown-menu" aria-labelledby="dropdown03">
                  <a class="dropdown-item" href="#">Action</a>
                  <a class="dropdown-item" href="#">Another action</a>
                  <a class="dropdown-item" href="#">Something else here</a>
                </div>
              </li>
            </ul>
            <form class="form-inline my-2 my-md-0">
              <input class="form-control" type="text" placeholder="Search">
            </form> -->
          </div>
      </nav>
      <!-- ナビゲーション終了-->


      <!-- ダイアグラム表示領域-->
      <section class="container">
          <div id="sankey_basic" class="w-100"></div>
          <div id="sankey_basic0" class="w-100"></div>
          <div id="sankey_basic1" class="w-100"></div>
          <div id="sankey_basic2" class="w-100"></div>
      </section>
      <!-- ダイアグラム表示領域_終了-->

      <!-- 保存領域-->
      <section class="container">
        <!-- <form > -->
          <label for="inputTitle" class="sr-only">タイトル</label>
          <input type="text" id="inputTitle" class="form-control " placeholder="タイトルを入力してください" >
          <label for="inputExplanation" class="sr-only">説明</label>
          <input type="text" id="inputExplanation" class="form-control" placeholder="ダイアグラムの説明を入力してください" >
          <button class="btn btn-md btn-danger "  id="saveDiagram">保存</button>
        <!-- </form> -->
      </section>
       <!-- 保存領域_終了-->      

    
      <!-- 入力領域-->
      <section class="container w-100">

          <div class="row">
              <table class="table table-sm col">
                  <thead class="thead-light">
                      <tr>
                        <th scope="col">No</th>
                        <th scope="col">From</th>
                        <th scope="col">To</th>
                        <th scope="col">Value</th>
                      </tr>
                  </thead>
                  <tbody id="rows">
                      <tr id="inputRow">
                          <th scope="row">1</th>
                          <td><input type="text" name="data_value1" value="A"/></td>
                          <td><input type="text" name="data_value2" value="D"/></td>
                          <td><input type="text" name="data_value3" value=10 /></td>
                          <td><button class="btn btn-sm btn-secondary" id="deletebtn">削除</button></td>
                      </tr>
                      <tr id="inputRow">
                          <th scope="row">2</th>
                          <td><input type="text" name="data_value1" value="B" /></td>
                          <td><input type="text" name="data_value2" value="D" /></td>
                          <td><input type="text" name="data_value3" value=10 /></td>
                          <td><button class="btn btn-sm btn-secondary" id="deletebtn">削除</button></td>

          
                      </tr>
                      <tr id="inputRow">
                          <th scope="row">3</th>
                          <td><input type="text" name="data_value1" value="C" /></td>
                          <td><input type="text" name="data_value2" value="D" /></td>
                          <td><input type="text" name="data_value3" value=10 /></td>
                          <td><button class="btn btn-sm btn-secondary" id="deletebtn">削除</button></td>

                      </tr>
                  </tbody>    
              </table>
              <!-- <div class="col">
                  <textarea class="w-100 h-50" id="text" ></textarea>
                  <button class="btn btn-lg btn-primary " id="TextToDiagram" >作成</button>
              </div> -->

          </div>
          <!-- 入力領域_終了-->


          <div class= "row">
            <button class="btn btn-md btn-primary col-1 mr-4" id="createRow">+列追加</button>
            <button class="btn btn-md btn-primary col-4" id="createDiagram"type="submit">ダイアグラム作成</button>
            <!-- <button class="btn btn-md btn-primary col-2" id="test" >test</button> -->

        </div>
      </section>

    <!--ログイン・サインインモーダルウィンドウ -->
    <!-- <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal">
      ログイン・サインイン
    </button> -->

    <!-- モーダルダイアログ -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">ダイアグラム作成のためには、ログインorサインインをして下さい</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>

          <div class="modal-body">
            <section class="container"> 
              <div class="row">
                  <div class="col border-right">
                      <form class="form-signin">
                          <img class="mb-4" src="./assets/brand/bootstrap-solid.svg" alt="" width="72" height="72">
                          <h1 class="h3 mb-3 font-weight-normal">サインイン済みの方はこちらから</h1>
                          <label for="loginUsername" class="sr-only">username</label>
                          <input type="text" id="loginUsername" class="form-control" placeholder="username" >
                          <label for="loginPassword" class="sr-only">Password</label>
                          <input type="text" id="loginPassword" class="form-control" placeholder="Password" >
                          <button class="btn btn-lg btn-primary btn-block"  id="loginbtn">ログイン</button>

                        </form>

                  </div>
                  <div class="col">
                      <form class="form-signin">
                          <img class="mb-4" src="./assets/brand/bootstrap-solid.svg" alt="" width="72" height="72">
                          <h1 class="h3 mb-3 font-weight-normal">サインインはこちらから</h1>
                          <label for="signinUsername" class="sr-only">username</label>
                          <input type="text" id="signinUsername" class="form-control" placeholder="username" >
                          <label for="signinPassword" class="sr-only">Password</label>
                          <input type="text" id="signinPassword" class="form-control" placeholder="Password" >
                          <label for="signinPasswordComfirm" class="sr-only">Password確認</label>
                          <input type="text" id="signinPasswordComfirm" class="form-control" placeholder="Password確認" >
                          <button class="btn btn-lg btn-primary btn-block" type="submit" id="signinbtn">サインイン</button>
                        </form>
                  </div>
              </div>
            </section>
            ...
          </div>

          <div class="modal-footer">
            <a  href="./index.html"><button type="button" class="btn btn-secondary" >ログインせずTopページに戻る</button></a>

          </div>
        </div>
      </div>
    </div>
    <!-- モーダルダイアログ終了 -->   
    <!--ログイン・サインインモーダルウィンドウ終了 -->
    
  </body>
  

<script type="module">
  

  // ■ファイル読み込み時の処理を行う
      // 配列の初期化
      console.log($('[name=data_value' + 1 +']')[2].value);
  
      // ダイアグラムNoの初期化
      let diagramNo = 0;

      // IFとなる配列を初期化
      let array =[];

      // firebaseの記述
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.2/firebase-app.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      import { getDatabase, ref, push, set, onChildAdded, remove, onChildRemoved, onValue }
          from "https://cdnjs.cloudflare.com/ajax/libs/firebase/9.6.2/firebase-database.min.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "",
        authDomain: "sankeydiagram-41542.firebaseapp.com",
        databaseURL: "https://sankeydiagram-41542-default-rtdb.firebaseio.com",
        projectId: "sankeydiagram-41542",
        storageBucket: "sankeydiagram-41542.appspot.com",
        messagingSenderId: "124476146008",
        appId: "1:124476146008:web:670bbc5545dc882583a52d"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      console.log(app);

      const db = getDatabase(app);
      console.log(db);

      const dbRefDiagrams = ref(db, "diagrams");
      const dbRefUsers= ref(db, "users");


      // ログイン状態に応じた処理
      // usernameをLSより取得し、ナビに記載
      if(localStorage.getItem("login")){
        let username = localStorage.getItem("login");
        $("#loginname").html("：" + localStorage.getItem("login"));
        console.log(localStorage.getItem("login"));
        // ログアウトボタンをつける
        var append =  `<li class="nav-item active"><a class="nav-link" id="logoutbtn" >ログアウト</a></li>`
        $("#navAppend").append(append);

      }else{
       $("#exampleModal").modal('show');

      }
 

      // ログイン・サインイン用、ユーザーリストを取得
        let user_list ={};
        onValue(ref(db, "users"),function(data){
        user_list = data.val();
        console.log(user_list);
        });

      
// ■関数の記述を行う
    // firebaseからユーザーリストを取得する
    function getUsers(){
        onValue(ref(db, "users"),function(data){
          user_list = data.val();
          console.log(user_list);
         })
        return user_list;
    }

      // firebaseからダイアグラムリストを取得する
      function getDiagrams(){
        onValue(ref(db, "diagrams"),function(data){
        diagram_list = data.val();
        console.log(diagram_list);
        })  
        return diagram_list;
      }

      // 表のデータを配列に格納する
      function SheetToArray(){
          var data_prop = [];
          var rows = 0;

  
          rows = $("tbody").children().length; //行の数
          console.log(`行数は${rows}`);

          //行ごとの値を配列にする
          for(var i = 0; i < rows; i++) {
              var input_arrays = [];
              console.log(i +"行目");
  
              for(var j = 1; j <= 3; j++) { 
                  var input_array = [];

                      if($('[name=data_value' + j +']')[i]){
                          console.log("contain");
                          if(j != 3){
                             console.log($('[name=data_value' + j +']')[i].value);
                             var addString =$('[name=data_value' + j +']')[i].value ;
                             console.log(addString);

                            input_array= input_array.concat(addString);

        
                        }else{
                          console.log($('[name=data_value' + j +']')[i].value);
                          var addNumber =Number($('[name=data_value' + j +']')[i].value) ;
                          console.log("addNumerのデータ型は" + typeof addNumber);
                          input_array= input_array.concat(addNumber);
                        }
                      // console.log(input_array);

                      }
                      console.log(input_array);
                      input_arrays = input_arrays.concat(input_array);
              }
              data_prop.push(input_arrays);
              console.log(data_prop);
          }
          return data_prop
      };

      // 対象のobjectの中に、target_key:target_valueの組み合わせが存在しているか
      // 2階層限定
      function isExist(object,target_key,target_value){
          labelA:
          for(var i = 0; i <1; i++){
              for (var key in object ){
                          // 既に同じIDが存在していた時
                          if(object[key][target_key] == target_value ){ 
                              return true;
                              break labelA;
                          }
                      }
                              return false;
          }
      }
      
      // 対象のobjectの中に、target_key:target_valueの組み合わせが存在しており、PWもあっているとき
      // 2階層限定
      function isMatch(object,target_key,target_value,target_key2,target_value2){
          labelB:
          for(var i = 0; i <1; i++){
              for (var key in object ){
                          // 既に同じIDが存在していた時
                          if(object[key][target_key] == target_value ){ 
      
                              if(object[key][target_key2] == target_value2){
                                  return true;
                                  break labelB;
                                }
                          }
                      }
                              return false;
          }
      }

  
  // ■ユーザー操作に関する記述を行う

      // ログインボタンを押した時の挙動を記載する
      // loginボタンを押したときにLSに当該ID,PWの組み合わせがあるか確認する
      $(document).on("click","#loginbtn", function(){

      let loginUsername =String($("#loginUsername").val());
      let loginPassword =$("#loginPassword").val();

      // 当該IDが存在しない場合、「存在しないIDですと返す」
      if(!isExist(user_list, "username", loginUsername)){
          alert("存在しないIDです");
          console.log(loginUsername);
      }
      // 当該IDが存在するがPWが間違っている場合、「PWが間違っています」と返す
      else if(!isMatch(user_list, "username", loginUsername ,"password", loginPassword)){
        alert("PWが間違っています。");     
      }
      // 当該IDが存在してPWもあっている場合、「ログインします」と返す
      else{
        alert("ログインします。");
        // login中のid名をLSに保存する
        localStorage.setItem("login", loginUsername);

        // モーダルウィンドウを消す

        };
      })

      // サインインボタンを押したときの挙動を記載する
      $(document).on("click","#signinbtn", function(){
        // 少なくとも一つの欄が空欄の場合、空欄の欄がありますと返す
        if($("#signinUsername").val() == "" || $("#signinPassword").val() =="" || $("#signinPasswordComfirm").val() == "" ){
            alert("入力されていない項目があります。")

        // pwのvalueとpw_againのvalueの値が一致しない場合、
        // パスワード欄とパスワード確認欄の値が異なりますと表示する。
        }else if($("#signinPassword").val() !== $("#signinPasswordComfirm").val()){
            alert("パスワード欄とパスワード確認欄の値が異なります");
            console.log($("#signinPassword").val());
            console.log($("#signinPasswordComfirm").val());

        // 入力したidnameが存在する場合、「存在するIDです」と返す
        }else if(isExist(user_list, "username", String($("#signinUsername").val()))){
            alert("存在するIDです、ログインページからログインしてください");

        // 入力したidnameが存在しない場合、「登録します」と返す
        }else{
            alert("登録します"+$("#signinUsername").val()+ $("#signinPassword").val() ); 
            const profile= {
                        username: $("#signinUsername").val(),
                        password: $("#signinPassword").val() 
                    };


            // firebaesに登録する
            const newPostRef = push(dbRefUsers);
            set(newPostRef, profile);

            // login中のid名をLSに保存する
            localStorage.setItem("login", $("#signinUsername").val());

          // モーダルウィンドウを消す
        }
      })

      // ログアウトボタンに関する処理
      // ログアウトボタンを押すと、LSのloginの値を空にして、ログインページに遷移する
      $(document).on("click","#logoutbtn", function(){
        localStorage.setItem("login","");
        window.location.href = "./index.html" ;
      })
          



      // 列作成ボタンを押したときの処理
      $("#createRow").on("click",function(){
          let row =`<tr id="inputRow"><th scope="row">${$("tbody").children().length + 1}</th><td><input type="text" name="data_value1" /></td><td><input type="text" name="data_value2" /></td><td><input type="text" name="data_value3" /></td><td><button class="btn btn-sm btn-secondary" id="deletebtn">削除</button></td></tr>`;
          $("#rows").append(row);
  
      });

      // testボタンを押したときの処理
      $("#test").on("click",function(){

          console.log(array);

          const diagramtest = {
              data: [     
                   [ '被保険者', '被用者保険者before', 10 ],
          [ '被保険者', '国民健康保険者before', 2.5 ],
          [ '被保険者', '後期高齢者医療費制度before', 1.9 ],
          [ '事業主', '被用者保険者before', 10  ],
          [ '国地方自治体', '被用者保険者before', 1.3 ],
          [ '国地方自治体', '国民健康保険者before', 4.7 ],
          [ '国地方自治体', '後期高齢者医療費制度before', 7.9  ],
          [ '被用者保険者before', '後期高齢者医療費制度after', 4.6 ],
          [ '国民健康保険者before', '後期高齢者医療費制度after',1.7  ],
          [ '被用者保険者before', '国民健康保険者after',3.6 ],
          [ '被用者保険者before', '被用者保険者after', 11.1 ],
          [ '国民健康保険者before', '国民健康保険者after', 8.1  ],
          [ '後期高齢者医療費制度before', '後期高齢者医療費制度after', 10.1 ],
          [ '被用者保険者after', '支払基金', 10.0 ],
          [ '後期高齢者医療費制度after', '国保連合会', 16.4 ],
          [ '国民健康保険者after', '国保連合会', 10.3 ],
          [ '支払基金', '保険医療機関', 10.0 ],
          [ '国保連合会', '保険医療機関', 26.7 ],
        ] ,
              title: "保険料診療報酬の金の流れ",
              explanation: "被用者保険、国保、前期高齢者",
              user: "ikebe0321",
            };

            // const diagramtest = {
            //   data: array,
            //   title: "test",
            //   explanation: "test",
            //   user: "ikebe0321",
            // };
          
          console.log(diagramtest);


          const diagramId = push(dbRefDiagrams);
          console.log(dbRefDiagrams);
          console.log(diagramId);

          set(diagramId, diagramtest);

      })
  
      // 削除ボタンを押したときの処理
      // 押されたボタンが属するtr要素を削除する
      $(document).on("click","#deletebtn", function(){
   
          // // 押されたボタンが属するli要素のvalueの値をkeyに格納
          //    const key = $(this).parents("li").attr("value");
      
          // // firebaseRDBのkey以下の要素を削除する
          //    remove(ref(db, "chat/" + key));
      
          //押されたボタンが属するli要素を削除する
             $(this).parents('tr').remove();
      })
   
  
      // 作成ボタンを押したときの処理
      $("#createDiagram").on("click",function(){
  
          console.log(diagramNo);
          
          // 古い表示領域を削除する
          // $(`#sankey_basic`).remove();
          
          // 表示領域を定義する
          diagramNo += 1;
          let Target = `sankey_basic${diagramNo}`;
          console.log(Target);
  
          array = SheetToArray();
      //     const array = [
      //     [ '被保険者', '被用者保険者before', 10 ],
      //     [ '被保険者', '国民健康保険者before', 2.5 ],
      //     [ '被保険者', '後期高齢者医療費制度before', 1.9 ],
      //     [ '事業主', '被用者保険者before', 10  ],
      //     [ '国地方自治体', '被用者保険者before', 1.3 ],
      //     [ '国地方自治体', '国民健康保険者before', 4.7 ],
      //     [ '国地方自治体', '後期高齢者医療費制度before', 7.9  ],
      //     [ '被用者保険者before', '後期高齢者医療費制度after', 4.6 ],
      //     [ '国民健康保険者before', '後期高齢者医療費制度after',1.7  ],
      //     [ '被用者保険者before', '国民健康保険者after',3.6 ],
      //     [ '被用者保険者before', '被用者保険者after', 11.1 ],
      //     [ '国民健康保険者before', '国民健康保険者after', 8.1  ],
      //     [ '後期高齢者医療費制度before', '後期高齢者医療費制度after', 10.1 ],
      //     [ '被用者保険者after', '支払基金', 10.0 ],
      //     [ '後期高齢者医療費制度after', '国保連合会', 16.4 ],
      //     [ '国民健康保険者after', '国保連合会', 10.3 ],
      //     [ '支払基金', '保険医療機関', 10.0 ],
      //     [ '国保連合会', '保険医療機関', 26.7 ],
      //   ] ;
  
      //   console.log(array);
  
  
          //sankey diagramの描画をする
          google.charts.load('current', {'packages':['sankey']});
          google.charts.setOnLoadCallback(drawChart);
  
          function drawChart() {
          var data = new google.visualization.DataTable();
          data.addColumn('string', 'From');
          data.addColumn('string', 'To');
          data.addColumn('number', 'Weight');
          data.addRows(array);
  
          // Sets chart options.
          var options = {
              width: 600,
          };
  
          // Instantiates and draws our chart, passing in some options.
          var chart = new google.visualization.Sankey(document.getElementById(`sankey_basic${diagramNo}`));
          // 'sankey_basic'
          chart.draw(data, options);
          }
      });

      // 保存ボタンを押した時の処理
      $("#saveDiagram").on("click",function(){
          // タイトルと説明を変数に格納
          var title = $("#inputTitle").val() ;
          var explanation = $("#inputExplanation").val();
           
          console.log(title);
          console.log(explanation);

          // タイトル、説明が空欄でないことを確認
          if(title == "" || explanation =="" || array =="" ){
           alert("入力されていない項目があります。")
          
          // ai
          }else{

            // ダイアグラムID生成
            // const diagramId = push(dbRefDiagrams);
            // console.log(diagramId );

            // ダイアグラムID,タイトル、説明のオブジェクトを生成
            const diagram = {
              data: array,
              title: title,
              explanation: explanation,
              user: localStorage.getItem("login")
            }
            alert(diagram + "登録する。")

            console.log(diagram);


            // firebaseに登録
            const diagramId = push(dbRefDiagrams);
            set(diagramId, diagram);

            // ダイアグラムIDをLSに保存
            localStorage.setItem("diagramId", diagramId.key);

          }
          

      })



</script>


  <!-- bootstrapの記述 -->

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
  <script>window.jQuery || document.write('<script src="./assets/js/vendor/jquery.slim.min.js"><\/script>')</script><script src="./assets/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>


</html>

<!-- [
        [ '被保険者', '被用者保険者before', 10 ],
        [ '被保険者', '国民健康保険者before', 2.5 ],
        [ '被保険者', '後期高齢者医療費制度before', 1.9 ],
        [ '事業主', '被用者保険者before', 10  ],
        [ '国地方自治体', '被用者保険者before', 1.3 ],
        [ '国地方自治体', '国民健康保険者before', 4.7 ],
        [ '国地方自治体', '後期高齢者医療費制度before', 7.9  ],
        [ '被用者保険者before', '後期高齢者医療費制度after', 4.6 ],
        [ '国民健康保険者before', '後期高齢者医療費制度after',1.7  ],
        [ '被用者保険者before', '国民健康保険者after',3.6 ],
        [ '被用者保険者before', '被用者保険者after', 11.1 ],
        [ '国民健康保険者before', '国民健康保険者after', 8.1  ],
        [ '後期高齢者医療費制度before', '後期高齢者医療費制度after', 10.1 ],
        [ '被用者保険者after', '支払基金', 10.0 ],
        [ '後期高齢者医療費制度after', '国保連合会', 16.4 ],
        [ '国民健康保険者after', '国保連合会', 10.3 ],
        [ '支払基金', '保険医療機関', 10.0 ],
        [ '国保連合会', '保険医療機関', 26.7 ],
      ] -->

